<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hello App</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-a: #0e7490;
        --bg-b: #020617;
        --card: rgba(15, 23, 42, 0.76);
        --text: #e2e8f0;
        --muted: #94a3b8;
        --accent: #22d3ee;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", system-ui, sans-serif;
        background: radial-gradient(circle at 20% 20%, var(--bg-a) 0%, var(--bg-b) 55%);
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: var(--text);
      }
      .wrap {
        max-width: 760px;
        margin: 36px auto;
        padding: 0 20px;
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 16px;
        padding: 20px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 28px;
      }
      p {
        margin: 8px 0;
        line-height: 1.5;
      }
      .subtle {
        color: var(--muted);
      }
      code {
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 2px 6px;
        border-radius: 6px;
      }
      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-top: 14px;
      }
      .panel {
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        padding: 12px;
        background: rgba(2, 6, 23, 0.5);
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      button {
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        border-radius: 8px;
        padding: 7px 10px;
        cursor: pointer;
      }
      button:hover {
        border-color: var(--accent);
        color: #a5f3fc;
      }
      input {
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.78);
        color: var(--text);
        border-radius: 8px;
        padding: 7px 10px;
        outline: none;
        min-width: 130px;
      }
      input:focus {
        border-color: var(--accent);
      }
      textarea {
        width: 100%;
        min-height: 96px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.78);
        color: var(--text);
        border-radius: 8px;
        padding: 8px 10px;
        outline: none;
        resize: vertical;
      }
      textarea:focus {
        border-color: var(--accent);
      }
      .accent {
        background: rgba(34, 211, 238, 0.22);
        border-color: rgba(34, 211, 238, 0.5);
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .toast {
        margin-top: 12px;
        min-height: 24px;
        color: #67e8f9;
      }
      .light {
        --bg-a: #bae6fd;
        --bg-b: #eff6ff;
        --card: rgba(255, 255, 255, 0.85);
        --text: #0f172a;
        --muted: #475569;
        --accent: #0284c7;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card">
        <h1>Hello App UI</h1>
        <p class="subtle">This page is loaded via <code>uiPath</code> in <code>app.json</code>.</p>
        <p class="subtle">Click buttons below to test local UI interactions quickly.</p>

        <div class="grid">
          <div class="panel">
            <p><strong>Counter</strong></p>
            <p class="mono">value: <span id="counter-value">0</span></p>
            <div class="row">
              <button id="counter-add">+1</button>
              <button id="counter-sub">-1</button>
              <button id="counter-reset">Reset</button>
            </div>
          </div>

          <div class="panel">
            <p><strong>Theme</strong></p>
            <p class="mono">mode: <span id="theme-value">dark</span></p>
            <div class="row">
              <button id="theme-toggle" class="accent">Toggle Theme</button>
            </div>
          </div>

          <div class="panel">
            <p><strong>Actions</strong></p>
            <div class="row">
              <button id="toast-btn">Show Message</button>
              <button id="time-btn">Current Time</button>
              <button id="pulse-btn">Pulse Card</button>
            </div>
          </div>

          <div class="panel">
            <p><strong>Launch Payload</strong></p>
            <p class="subtle">Use search, press Space to select app, then type payload and press Enter.</p>
            <p class="mono" id="launch-payload-value">(none)</p>
            <p class="subtle mono" id="launch-payload-meta">updated: -</p>
          </div>

          <div class="panel">
            <p><strong>Host KV Storage</strong></p>
            <p class="subtle mono" id="kv-runtime-info">runtime: loading...</p>
            <div class="row">
              <input id="kv-key" placeholder="key" value="demo.counter" />
              <input id="kv-value" placeholder='value JSON (e.g. {"n":1})' value='{"count":0}' />
            </div>
            <div class="row">
              <button id="kv-load-btn">Load</button>
              <button id="kv-save-btn" class="accent">Save</button>
              <button id="kv-delete-btn">Delete</button>
              <button id="kv-list-btn">List</button>
              <button id="kv-clear-btn">Clear</button>
            </div>
            <p id="kv-output" class="subtle mono"></p>
          </div>

          <div class="panel">
            <p><strong>Host File API</strong></p>
            <p class="subtle mono">path: <code>runtime/note.txt</code></p>
            <div class="row">
              <button id="file-write-btn">Write Note</button>
              <button id="file-read-btn">Read Note</button>
            </div>
            <p id="file-output" class="subtle mono"></p>
          </div>

          <div class="panel" style="grid-column: 1 / -1">
            <p><strong>Arbitrary Path File (Host System API)</strong></p>
            <p class="subtle">
              This example calls <code>window.toolHubAppApi.systemFiles</code> in the host preload.
              Protected files (for example hosts) may require admin rights.
            </p>
            <div class="row">
              <input
                id="any-path-input"
                class="mono"
                style="min-width: 420px; flex: 1"
                value="C:\\Windows\\System32\\drivers\\etc\\hosts"
                placeholder="Absolute file path"
              />
            </div>
            <textarea
              id="any-path-content"
              class="mono"
              placeholder="File content for write operations..."
            ></textarea>
            <div class="row" style="margin-top: 8px">
              <button id="any-path-read-btn">Read</button>
              <button id="any-path-write-btn" class="accent">Write (Replace)</button>
              <button id="any-path-append-btn">Write (Append)</button>
            </div>
            <p id="any-path-output" class="subtle mono"></p>
          </div>
        </div>

        <div id="toast" class="toast mono"></div>
      </section>
    </main>

    <script>
      window.addEventListener("error", (event) => {
        const toastEl = document.getElementById("toast");
        if (toastEl) {
          toastEl.textContent = `UI script error: ${event.message}`;
        }
      });

      const counterValue = document.getElementById("counter-value");
      const themeValue = document.getElementById("theme-value");
      const toast = document.getElementById("toast");
      const card = document.querySelector(".card");
      const kvRuntimeInfo = document.getElementById("kv-runtime-info");
      const kvOutput = document.getElementById("kv-output");
      const launchPayloadValue = document.getElementById("launch-payload-value");
      const launchPayloadMeta = document.getElementById("launch-payload-meta");
      const kvKeyInput = document.getElementById("kv-key");
      const kvValueInput = document.getElementById("kv-value");
      const fileOutput = document.getElementById("file-output");
      const anyPathInput = document.getElementById("any-path-input");
      const anyPathContent = document.getElementById("any-path-content");
      const anyPathOutput = document.getElementById("any-path-output");
      let hostAppApi = null;
      let unsubscribeLaunchPayload = null;
      try {
        hostAppApi = window.toolHubAppApi ?? null;
      } catch (error) {
        console.error("Read toolHubAppApi failed:", error);
      }

      let count = 0;
      let darkMode = true;

      function renderCounter() {
        counterValue.textContent = String(count);
      }

      function showToast(text) {
        toast.textContent = text;
        clearTimeout(showToast._timer);
        showToast._timer = setTimeout(() => {
          toast.textContent = "";
        }, 1600);
      }

      function renderLaunchPayload(payload, updatedAt) {
        const normalizedPayload = typeof payload === "string" ? payload : "";
        launchPayloadValue.textContent = normalizedPayload || "(none)";
        if (updatedAt) {
          launchPayloadMeta.textContent = `updated: ${new Date(updatedAt).toLocaleString()}`;
          return;
        }
        launchPayloadMeta.textContent = "updated: -";
      }

      document.getElementById("counter-add").addEventListener("click", () => {
        count += 1;
        renderCounter();
      });

      document.getElementById("counter-sub").addEventListener("click", () => {
        count -= 1;
        renderCounter();
      });

      document.getElementById("counter-reset").addEventListener("click", () => {
        count = 0;
        renderCounter();
      });

      document.getElementById("theme-toggle").addEventListener("click", () => {
        darkMode = !darkMode;
        document.body.classList.toggle("light", !darkMode);
        themeValue.textContent = darkMode ? "dark" : "light";
      });

      document.getElementById("toast-btn").addEventListener("click", () => {
        showToast("Interaction success: UI event handled.");
      });

      document.getElementById("time-btn").addEventListener("click", () => {
        showToast(`Now: ${new Date().toLocaleTimeString()}`);
      });

      document.getElementById("pulse-btn").addEventListener("click", () => {
        card.animate(
          [
            { transform: "scale(1)" },
            { transform: "scale(1.015)" },
            { transform: "scale(1)" },
          ],
          { duration: 320, easing: "ease-out" },
        );
      });

      async function runKvAction(action) {
        if (!hostAppApi?.storage) {
          kvRuntimeInfo.textContent = "runtime: toolHubAppApi is unavailable";
          showToast("Host storage API is unavailable.");
          return;
        }

        try {
          const result = await action();
          kvOutput.textContent = JSON.stringify(result, null, 2);
          showToast("Host storage call succeeded.");
        } catch (error) {
          kvOutput.textContent = String(error?.message || error);
          showToast("Host storage call failed.");
        }
      }

      if (hostAppApi?.getRuntimeInfo) {
        hostAppApi
          .getRuntimeInfo()
          .then((info) => {
            kvRuntimeInfo.textContent = `runtime appId: ${info?.appId || "-"}`;
            renderLaunchPayload(info?.launchPayload, info?.launchPayloadUpdatedAt);
          })
          .catch(() => {
            kvRuntimeInfo.textContent = "runtime appId: unavailable";
            renderLaunchPayload(null, null);
          });
      } else {
        kvRuntimeInfo.textContent = "runtime: toolHubAppApi is unavailable";
        renderLaunchPayload(null, null);
      }

      if (hostAppApi?.subscribeLaunchPayload) {
        unsubscribeLaunchPayload = hostAppApi.subscribeLaunchPayload((payload) => {
          renderLaunchPayload(payload?.launchPayload, payload?.launchPayloadUpdatedAt);
          showToast("Launch payload updated.");
        });
      }

      window.addEventListener("beforeunload", () => {
        try {
          unsubscribeLaunchPayload?.();
        } catch {
          // Ignore unsubscribe errors.
        }
        unsubscribeLaunchPayload = null;
      });

      document.getElementById("kv-load-btn").addEventListener("click", () => {
        runKvAction(() => hostAppApi.storage.get(kvKeyInput.value));
      });

      document.getElementById("kv-save-btn").addEventListener("click", () => {
        let value;
        try {
          value = JSON.parse(kvValueInput.value);
        } catch {
          value = kvValueInput.value;
        }
        runKvAction(() => hostAppApi.storage.set(kvKeyInput.value, value));
      });

      document.getElementById("kv-delete-btn").addEventListener("click", () => {
        runKvAction(() => hostAppApi.storage.delete(kvKeyInput.value));
      });

      document.getElementById("kv-list-btn").addEventListener("click", () => {
        runKvAction(() => hostAppApi.storage.list(""));
      });

      document.getElementById("kv-clear-btn").addEventListener("click", () => {
        runKvAction(() => hostAppApi.storage.clear());
      });

      document.getElementById("file-write-btn").addEventListener("click", async () => {
        if (!hostAppApi?.files) {
          fileOutput.textContent = "file api unavailable";
          showToast("Host file API is unavailable.");
          return;
        }
        try {
          const text = `updated at ${new Date().toISOString()}\n`;
          const result = await hostAppApi.files.write("runtime/note.txt", text, {
            append: false,
            createDirs: true,
          });
          fileOutput.textContent = JSON.stringify(result, null, 2);
          showToast("File write succeeded.");
        } catch (error) {
          fileOutput.textContent = String(error?.message || error);
          showToast("File write failed.");
        }
      });

      document.getElementById("file-read-btn").addEventListener("click", async () => {
        if (!hostAppApi?.files) {
          fileOutput.textContent = "file api unavailable";
          showToast("Host file API is unavailable.");
          return;
        }
        try {
          const result = await hostAppApi.files.read("runtime/note.txt");
          fileOutput.textContent = JSON.stringify(result, null, 2);
          showToast("File read succeeded.");
        } catch (error) {
          fileOutput.textContent = String(error?.message || error);
          showToast("File read failed.");
        }
      });

      function getSystemFilesApi() {
        if (!hostAppApi?.systemFiles) {
          throw new Error("Host systemFiles API is unavailable.");
        }
        return hostAppApi.systemFiles;
      }

      document.getElementById("any-path-read-btn").addEventListener("click", async () => {
        try {
          const data = await getSystemFilesApi().read(anyPathInput.value);
          anyPathContent.value = data.content || "";
          anyPathOutput.textContent = JSON.stringify(
            { path: data.path, size: data.size, truncated: data.truncated },
            null,
            2,
          );
          showToast("Arbitrary path read succeeded.");
        } catch (error) {
          anyPathOutput.textContent = String(error?.message || error);
          showToast("Arbitrary path read failed.");
        }
      });

      document.getElementById("any-path-write-btn").addEventListener("click", async () => {
        try {
          const data = await getSystemFilesApi().write(
            anyPathInput.value,
            anyPathContent.value,
            { append: false },
          );
          anyPathOutput.textContent = JSON.stringify(data, null, 2);
          showToast("Arbitrary path write succeeded.");
        } catch (error) {
          anyPathOutput.textContent = String(error?.message || error);
          showToast("Arbitrary path write failed.");
        }
      });

      document.getElementById("any-path-append-btn").addEventListener("click", async () => {
        try {
          const data = await getSystemFilesApi().write(
            anyPathInput.value,
            anyPathContent.value,
            { append: true },
          );
          anyPathOutput.textContent = JSON.stringify(data, null, 2);
          showToast("Arbitrary path append succeeded.");
        } catch (error) {
          anyPathOutput.textContent = String(error?.message || error);
          showToast("Arbitrary path append failed.");
        }
      });
    </script>
  </body>
</html>
